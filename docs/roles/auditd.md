# Auditd rules

Copyright (C) 2020 Dmitriy Prigoda deamon.none@gmail.com This script is free software: Everyone is permitted to copy and distribute verbatim copies of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License.

## Содержание

1. [Общее описание](#общее-описание)
2. [Параметры](#параметры)
3. [Теги](#теги)
4. [Примеры](#примеры)
5. [Дополнительные материалы](#дополнительные-материалы)

## Общее описание
Для проведения аудита на серверах под управлением Linux-систем используют демон auditd. Он предназначен для комплексной проверки операционной системы Linux, например, для регистрации различных событий, анализа действий программ и предоставления информации администратору по заданным шаблонам. Роль генерирует набор правил для отслеживания системных вызовов доступа к фалам, сетевую активность, действий пользователя в консоли.

!!! note
    На высоко нагруженных системах с большой пользовательской активностью возможно сгенерировать минимальный набор правил отключив отслеживание некоторых событий. Для этого необходимо явно указать необходимо ли это. 

!!! bug
    В настройке auditd изменены следующие опции: `max_log_file = 50` - ограничение на размер файла в мегабайтах, `num_logs = 10` - максимальное число файлов, `disp_qos = lossless` - разрешить ли блокирование при взаимодействии с диспетчером, для передачи информации диспетчеру используется буфер размером 128 кб. (https://access.redhat.com/solutions/3025421)

!!! hint
    Для просмотра события используестя команда: ausearch -k <key>

Правила записывают следующие системные вызовы:

|Имя правила <key>              | Описание                                                       | Минимальный набор правил |    
|:-----------------------------:|:--------------------------------------------------------------:|:------------------------:|
|auditkernel                    | Вызов загружаемых модулей ядра.                                | ОТСУТСТВУЕТ              |
|auditconf                      | Изменение параметров ядра.                                     | ПРИСУТСТВУЕТ             |
|auditconn                      | Установленные сетевые соединения.                              | ОТСУТСТВУЕТ              | 
|audit-rootfile                 | Создание файлов с правами root'а.                              | ПРИСУТСТВУЕТ             |
|audit-userfile                 | Доступ к файлам не системными пользователями.                  | ОТСУТСТВУЕТ              |
|auditfaccessauditfaccess       | Неавторизованный доступ.                                       | ОТСУТСТВУЕТ              |
|auditdocker                    | Запуск Docker контейнеров.                                     | ОТСУТСТВУЕТ              |
|sudo_modification              | Модификация политик sudoers.                                   | ПРИСУТСТВУЕТ             |
|passwd_modification            | Изменение файла "/etc/passwd".                                 | ПРИСУТСТВУЕТ             |
|user_modification              | Создание и модификация локальных пользователей.                | ОТСУТСТВУЕТ              |
|group_modification             | Создание и модификация локальных групп.                        | ОТСУТСТВУЕТ              |
|network и network_modifications| Изменения конфигурации сетевых настроек.                       | ПРИСУТСТВУЕТ             |
|deletelog                      | Удаление журналов.                                             | ПРИСУТСТВУЕТ             |
|accesslog                      | Переименование и смена прав на файлы журналов.                 | ПРИСУТСТВУЕТ             |
|rootcmd                        | Запись выполненных команд из под root'а.                       | ПРИСУТСТВУЕТ             |
|usercmd                        | Запись выполненных команд из под не системных пользователей.   | ПРИСУТСТВУЕТ             |

## Параметры
|Название переменной               | Тип переменной | Значения по умолчанию | Описание                                                    |
|:--------------------------------:|:--------------:|:---------------------:|:------------------------------------------------------------|
|auditd_custom_rules               | array          | undef                 | Дополнительные правила.                                     |
|auditd_buffer_size                | string         | 8192                  | Размер буфера до записи данныых на диск.                    |
|auditd_failure_mode               | string         | 1                     | Действия при невозможности записать данные.                 |
|auditd_enable_flag                | string         | 2                     | Параметр защиты правил от изменения.                        |
|min_audit                         | boolean        | undef (false)         | Генерирует минимальный набор правил.                        |

## Теги
|Тег            | Описание                     |
|:--------------|:-----------------------------|
|change_rules   | Модификация правил аудита.   |

## Примеры

### inventory/hosts

```
    [example-servers]
    <host_name> ansible_ssh_host=<host_ip> ansible_ssh_user=<user_name_for_connect>

    [example-servers:vars]
    ansible_connection=ssh
    min_audit=true
    # Регистрация только тех событий, при которых файл открывается только на запись и изменение атрибутов
    # в директории '/etc':
    auditd_custom_rules=['-a exit,always -S open -F path=/etc/ -F perm=aw']
```

## Дополнительные материалы

- [Auditd](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/sec-starting_the_audit_service)
- [Audit framework](https://wiki.archlinux.org/index.php/Audit_framework)
- [Аудит системных событий в Linux](https://xakep.ru/2011/03/30/54897/)